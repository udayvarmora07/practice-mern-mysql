# =============================================================================
# Backend CI/CD Pipeline
# Build AMI â†’ Update Launch Template â†’ Deploy with Ansible
# =============================================================================

name: Backend Deploy Pipeline

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'packer/**'

env:
  AWS_REGION: ap-south-1
  PACKER_VERSION: '1.10.0'
  LAUNCH_TEMPLATE_NAME: 'backend-launch-template'
  ASG_NAME: 'test-asg'

jobs:
  # ===========================================================================
  # Job 1: Build AMI with Packer
  # ===========================================================================
  build-ami:
    name: Build AMI
    runs-on: ubuntu-latest
    
    outputs:
      ami_id: ${{ steps.extract-ami.outputs.ami_id }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Packer Init
        run: packer init packer/templates/backend.pkr.hcl

      - name: Packer Validate
        run: |
          packer validate \
            -var-file=packer/variables/variables.pkr.hcl \
            -var "source_ami=${{ secrets.BASE_AMI_ID }}" \
            packer/templates/backend.pkr.hcl

      - name: Make scripts executable
        run: chmod +x packer/scripts/*.sh

      - name: Build AMI with Packer
        run: |
          packer build \
            -var-file=packer/variables/variables.pkr.hcl \
            -var "source_ami=${{ secrets.BASE_AMI_ID }}" \
            -var "app_version=${{ github.sha }}" \
            packer/templates/backend.pkr.hcl

      - name: Extract AMI ID from manifest
        id: extract-ami
        run: |
          AMI_ID=$(jq -r '.builds[-1].artifact_id' packer/packer-manifest.json | cut -d':' -f2)
          echo "ami_id=${AMI_ID}" >> $GITHUB_OUTPUT
          echo "Built AMI: ${AMI_ID}"

      - name: Upload Packer manifest
        uses: actions/upload-artifact@v4
        with:
          name: packer-manifest
          path: packer/packer-manifest.json
          retention-days: 30

  # ===========================================================================
  # Job 2: Update Launch Template & ASG
  # ===========================================================================
  update-launch-template:
    name: Update Launch Template
    runs-on: ubuntu-latest
    needs: [build-ami]
    
    outputs:
      new_version: ${{ steps.create-version.outputs.new_version }}
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Launch Template details
        id: get-lt
        run: |
          LT_ID=$(aws ec2 describe-launch-templates \
            --launch-template-names ${{ env.LAUNCH_TEMPLATE_NAME }} \
            --query 'LaunchTemplates[0].LaunchTemplateId' \
            --output text)
          
          echo "lt_id=${LT_ID}" >> $GITHUB_OUTPUT
          echo "Launch Template ID: ${LT_ID}"

      - name: Create new Launch Template version
        id: create-version
        run: |
          AMI_ID="${{ needs.build-ami.outputs.ami_id }}"
          LT_ID="${{ steps.get-lt.outputs.lt_id }}"
          
          NEW_VERSION=$(aws ec2 create-launch-template-version \
            --launch-template-id ${LT_ID} \
            --source-version '$Latest' \
            --launch-template-data "{\"ImageId\":\"${AMI_ID}\"}" \
            --version-description "AMI ${AMI_ID} - Commit ${{ github.sha }}" \
            --query 'LaunchTemplateVersion.VersionNumber' \
            --output text)
          
          echo "new_version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "Created Launch Template version: ${NEW_VERSION}"

      - name: Set new version as default
        run: |
          aws ec2 modify-launch-template \
            --launch-template-id ${{ steps.get-lt.outputs.lt_id }} \
            --default-version ${{ steps.create-version.outputs.new_version }}
          
          echo "Set default version to: ${{ steps.create-version.outputs.new_version }}"

      - name: Check ASG Launch Template version setting
        id: check-asg
        run: |
          ASG_CONFIG=$(aws autoscaling describe-auto-scaling-groups \
            --auto-scaling-group-names ${{ env.ASG_NAME }} \
            --query 'AutoScalingGroups[0]')
          
          LT_SPEC=$(echo $ASG_CONFIG | jq -r '.LaunchTemplate // empty')
          MIXED_LT=$(echo $ASG_CONFIG | jq -r '.MixedInstancesPolicy.LaunchTemplate.LaunchTemplateSpecification // empty')
          
          if [ -n "$LT_SPEC" ]; then
            LT_VERSION=$(echo $LT_SPEC | jq -r '.Version')
            LT_ID=$(echo $LT_SPEC | jq -r '.LaunchTemplateId')
          elif [ -n "$MIXED_LT" ]; then
            LT_VERSION=$(echo $MIXED_LT | jq -r '.Version')
            LT_ID=$(echo $MIXED_LT | jq -r '.LaunchTemplateId')
          else
            echo "No Launch Template found on ASG"
            LT_VERSION='$Latest'
          fi
          
          echo "lt_version=${LT_VERSION}" >> $GITHUB_OUTPUT
          echo "lt_id=${LT_ID}" >> $GITHUB_OUTPUT
          echo "ASG Launch Template Version: ${LT_VERSION}"

      - name: Update ASG to use new Launch Template version
        if: steps.check-asg.outputs.lt_version != '$Latest'
        run: |
          NEW_VERSION="${{ steps.create-version.outputs.new_version }}"
          LT_ID="${{ steps.check-asg.outputs.lt_id }}"
          
          echo "ASG is not using \$Latest, updating to version ${NEW_VERSION}"
          
          aws autoscaling update-auto-scaling-group \
            --auto-scaling-group-name ${{ env.ASG_NAME }} \
            --launch-template "LaunchTemplateId=${LT_ID},Version=${NEW_VERSION}"
          
          echo "Updated ASG to use Launch Template version: ${NEW_VERSION}"

      - name: Skip ASG update (using $Latest)
        if: steps.check-asg.outputs.lt_version == '$Latest'
        run: |
          echo "ASG is configured to use \$Latest - no update needed"

  # ===========================================================================
  # Job 3: Deploy to existing instances with Ansible
  # ===========================================================================
  deploy:
    name: Deploy with Ansible
    runs-on: ubuntu-latest
    needs: [update-launch-template]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Install Ansible
        run: |
          sudo apt update
          sudo apt install -y ansible
      
      - name: Set up SSH key
        run: |
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ec2_key.pem
          chmod 600 ec2_key.pem
      
      - name: Install Node.js and NPM
        run: |
          curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          nvm install 22.17.0
          nvm use 22.17.0
          node --version
          npm --version
      
      - name: Fetch EC2 instances from Auto Scaling Group
        id: fetch_instances
        run: |
          echo "[ec2_instances]" > inventory.ini
          aws ec2 describe-instances \
             --instance-ids $(aws autoscaling describe-auto-scaling-groups \
             --region ap-south-1 \
             --auto-scaling-group-names ${{ env.ASG_NAME }} \
             --query "AutoScalingGroups[].Instances[].InstanceId" \
             --output text) \
          --region ap-south-1 \
          --query "Reservations[].Instances[].PrivateIpAddress" \
          --output text | tr -s '\t ' '\n' >> inventory.ini
          
          echo "" >> inventory.ini
          echo "[ec2_instances:vars]" >> inventory.ini
          echo "ansible_user=ubuntu" >> inventory.ini
          echo "ansible_ssh_private_key_file=./ec2_key.pem" >> inventory.ini
          BASTION="${{ secrets.BASTION_HOST }}"
          echo "ansible_ssh_common_args=-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ProxyCommand=\"ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i ./ec2_key.pem -W %h:%p ubuntu@${BASTION}\"" >> inventory.ini

      - name: Set up Ansible inventory file
        run: |
          cat inventory.ini
      
      - name: Test bastion SSH connection
        run: |
          echo "Testing SSH connection to bastion: ${{ secrets.BASTION_HOST }}"
          ssh -v -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10 -i ./ec2_key.pem ubuntu@${{ secrets.BASTION_HOST }} "echo 'Bastion connection successful'" || echo "Bastion connection failed"
      
      - name: Update code on EC2 instances
        run: |
          cat <<EOF > deploy-playbook.yml
          ---
          - name: Deploy code to EC2 instances
            hosts: ec2_instances
            become: yes
            tasks:
              - name: Pull latest code from GitHub
                git:
                  repo: "https://github.com/udayvarmora07/practice-mern-mysql-backend.git"
                  dest: "/var/www/app/"
                  version: "main"
                  force: yes
                  update: yes
                  accept_hostkey: yes
              - name: Fix directory ownership
                file:
                  path: /var/www/app
                  owner: ubuntu
                  group: ubuntu
                  recurse: yes
              - name: Install NPM dependencies
                become_user: ubuntu
                shell: |
                  export NVM_DIR="/home/ubuntu/.nvm"
                  [ -s "\$NVM_DIR/nvm.sh" ] && . "\$NVM_DIR/nvm.sh"
                  cd /var/www/app/backend
                  npm install
                args:
                  executable: /bin/bash
              - name: Restart PM2 with ecosystem.config.js
                become_user: ubuntu
                shell: |
                  export NVM_DIR="/home/ubuntu/.nvm"
                  [ -s "\$NVM_DIR/nvm.sh" ] && . "\$NVM_DIR/nvm.sh"
                  cd /var/www/app/backend
                  pm2 restart ecosystem.config.js --update-env
                args:
                  executable: /bin/bash
          EOF

          ansible-playbook -i inventory.ini deploy-playbook.yml

      - name: Clean up
        run: |
          rm -f deploy-playbook.yml inventory.ini ec2_key.pem

  # ===========================================================================
  # Job 4: Summary
  # ===========================================================================
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [build-ami, update-launch-template, deploy]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build AMI | ${{ needs.build-ami.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Update Launch Template | ${{ needs.update-launch-template.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy with Ansible | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Details" >> $GITHUB_STEP_SUMMARY
          echo "- **AMI ID**: \`${{ needs.build-ami.outputs.ami_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Launch Template Version**: \`${{ needs.update-launch-template.outputs.new_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY