name: EC2 Deploy with Ansible

on:
  push:
    branches:
      - main  # You can modify this to trigger on different branches if needed.

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # Step 1: Checkout the code repository
    - name: Checkout repository
      uses: actions/checkout@v2
    
    # Step 2: Set up AWS CLI for accessing EC2 instances
    - name: Set up AWS CLI
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}
    
    # Step 3: Install Ansible
    - name: Install Ansible
      run: |
        sudo apt update
        sudo apt install -y ansible
    
    # Step 4: Set up SSH key for Ansible
    - name: Set up SSH key
      run: |
        echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ec2_key.pem
        chmod 600 ec2_key.pem
    
    # Step 5: Install Node.js using nvm
    - name: Install Node.js and NPM
      run: |
        curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
        export NVM_DIR="$HOME/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
        nvm install 22.17.0
        nvm use 22.17.0
        node --version
        npm --version
    
    # Step 6: Fetch EC2 instances (Auto Scaling Group instances)
    - name: Fetch EC2 instances from Auto Scaling Group
      id: fetch_instances
      run: |
        # Assuming you are using an Auto Scaling Group with tags to identify the instances
          echo "[ec2_instances]" > inventory.ini
          aws ec2 describe-instances \
             --instance-ids $(aws autoscaling describe-auto-scaling-groups \
             --region ap-south-1 \
             --auto-scaling-group-names test-asg \
             --query "AutoScalingGroups[].Instances[].InstanceId" \
             --output text) \
          --region ap-south-1 \
          --query "Reservations[].Instances[].PrivateIpAddress" \
          --output text | tr -s '\t ' '\n' >> inventory.ini
          
          # Add SSH configuration to inventory with bastion host
          echo "" >> inventory.ini
          echo "[ec2_instances:vars]" >> inventory.ini
          echo "ansible_user=ubuntu" >> inventory.ini
          echo "ansible_ssh_private_key_file=./ec2_key.pem" >> inventory.ini
          BASTION="${{ secrets.BASTION_HOST }}"
          echo "ansible_ssh_common_args=-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ProxyCommand=\"ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i ./ec2_key.pem -W %h:%p ubuntu@${BASTION}\"" >> inventory.ini

    # Step 7: Set up Ansible inventory file
    - name: Set up Ansible inventory file
      run: |
        cat inventory.ini
    
    # Step 7.5: Debug - Test bastion connection
    - name: Test bastion SSH connection
      run: |
        echo "Testing SSH connection to bastion: ${{ secrets.BASTION_HOST }}"
        ssh -v -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10 -i ./ec2_key.pem ubuntu@${{ secrets.BASTION_HOST }} "echo 'Bastion connection successful'" || echo "Bastion connection failed"
    
    # Step 8: Pull the latest code from GitHub on the EC2 instances using Ansible
    - name: Update code on EC2 instances
      run: |
        cat <<EOF > deploy-playbook.yml
        ---
        - name: Deploy code to EC2 instances
          hosts: ec2_instances
          become: yes
          tasks:
            - name: Pull latest code from GitHub
              git:
                repo: "https://github.com/udayvarmora07/practice-mern-mysql.git"
                dest: "/var/www/app/"
                version: "main"
                force: yes
                update: yes
                accept_hostkey: yes
            - name: Install NPM dependencies
              shell: |
                export NVM_DIR="$HOME/.nvm"
                [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
                cd /var/www/app/backend
                npm install
              args:
                executable: /bin/bash
            - name: Restart PM2 with ecosystem.config.js
              shell: |
                export NVM_DIR="$HOME/.nvm"
                [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
                cd /var/www/app/backend
                pm2 restart ecosystem.config.js --update-env
              args:
                executable: /bin/bash
        EOF

        ansible-playbook -i inventory.ini deploy-playbook.yml

    # Step 9: Clean up any temporary files or artifacts if necessary
    - name: Clean up
      run: |
        rm -f deploy-playbook.yml inventory.ini ec2_key.pem